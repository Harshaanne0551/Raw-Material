
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Raw Material Entry - Bannu Enterprises</title>
  <style>
    /* Your existing CSS remains the same */
    body {
      font-family: 'Arial', sans-serif;
      font-size: 13px;
      margin: 0;
      padding: 30px;
      background: #fff;
    }

    .invoice-box {
      width: 100%;
      margin: auto;
      margin-bottom: -13px;
      border: 2px solid #000;
      padding: 20px;
      color: #000;
      height: auto;
      box-sizing: border-box;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      font-weight: bold;
      border-bottom: 1px solid #000;
      padding-bottom: 5px;
    }

    .title {
      text-align: center;
      margin-top: 10px;
    }

    .title h2 {
      margin: 5px 0;
      font-size: 20px;
      color: #003366;
      text-shadow: 0.5px 0.5px #ccc;
    }

    .title p {
      margin: 2px 0;
      font-weight: bold;
    }

    .address {
      text-align: center;
      font-size: 13px;
    }

    .info-line {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
    }

    .manual-input {
      margin-top: 5px;
      display: none;
    }

    .section {
      margin-top: 25px;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 15px;
    }

    .section-title {
      background-color: #003366;
      color: white;
      padding: 5px 10px;
      margin: -15px -15px 15px -15px;
      border-radius: 4px 4px 0 0;
      font-weight: bold;
    }

    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #003366;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    button {
      margin-top: 10px;
      padding: 10px 20px;
      background-color: #003366;
      color: white;
      border: none;
      cursor: pointer;
      border-radius: 4px;
    }

    #afterSubmitButtons {
      display: none;
    }

    .material-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
      align-items: end;
    }

    @media print {
      body * {
        visibility: hidden;
      }
      #invoiceBox, #invoiceBox * {
        visibility: visible;
      }
      #invoiceBox {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
    }
  </style>
</head>
<body onload="initializeInvoice()">

<div class="invoice-box" id="invoiceBox">
  <div class="top-bar">
    <div>GST No: 36AHKPA9847Q1ZI</div>
    <div>Cell: 9440607963</div>
  </div>
  <div class="title">
    <div style="background-color:#003366;color:white;display:inline-block;padding:3px 12px;font-weight:bold;border-radius:4px;">
      RAW MATERIAL ENTRY
    </div>
    <h2>BANNU ENTERPRISES</h2>
    <p>MFGRS OF ALL TYPES OF NOTEBOOKS, LONG BOOKS, REGISTERS</p>
  </div>

  <div class="address"># 5-2-904, Rasal Abdullah, Osmangunj, Hyderabad.</div>
  <div class="info-line">
    <div><strong>Receipt No:</strong> <span id="invoiceNo"></span></div>
    <div><strong>Date:</strong> <span id="invoiceDate"></span></div>
  </div>

  <!-- Paper Section -->
  <div class="section">
    <div class="section-title">PAPER</div>
    <div class="material-row">
      <div class="form-group">
        <label>Vendor</label>
        <select id="paperVendor" onchange="toggleManualInput('paperVendor')">
          <option value="">Select Vendor</option>
          <option value="Srinivasa">Srinivasa</option>
          <option value="Bang">Bang</option>
          <option value="Govind">Govind</option>
          <option value="B S Corporation">B S Corporation</option>
          <option value="other">Other (Manual Entry)</option>
        </select>
        <input type="text" id="manualPaperVendor" class="manual-input" placeholder="Enter Vendor Name">
      </div>
      
      <div class="form-group">
        <label>Company</label>
        <select id="paperCompany" onchange="toggleManualInput('paperCompany')">
          <option value="">Select Company</option>
          <option value="Andhra Write Choice">Andhra Write Choice</option>
          <option value="Splendor">Splendor</option>
          <option value="West Coast">West Coast</option>
          <option value="Rough">Rough</option>
          <option value="Krishna Prabhas">Krishna Prabhas</option>
          <option value="other">Other (Manual Entry)</option>
        </select>
        <input type="text" id="manualPaperCompany" class="manual-input" placeholder="Enter Company Name">
      </div>
      
      <div class="form-group">
        <label>Type</label>
        <select id="paperType">
          <option value="">Select Type</option>
          <option value="Reel">Reel</option>
          <option value="Sheet">Sheet</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Size</label>
        <input type="text" id="paperSize" placeholder="Enter Size">
      </div>
      
      <div class="form-group">
        <label>GSM</label>
        <select id="paperGsm" onchange="toggleManualInput('paperGsm')">
          <option value="">Select GSM</option>
          <option value="48">48</option>
          <option value="50">50</option>
          <option value="52">52</option>
          <option value="54">54</option>
          <option value="56">56</option>
          <option value="57">57</option>
          <option value="58">58</option>
          <option value="68">68</option>
          <option value="other">Other (Manual Entry)</option>
        </select>
        <input type="text" id="manualPaperGsm" class="manual-input" placeholder="Enter GSM Value">
      </div>
      
      <div class="form-group">
        <label>Grade</label>
        <select id="paperGrade" onchange="toggleManualInput('paperGrade')">
          <option value="">Select Grade</option>
          <option value="A Grade">A Grade</option>
          <option value="B Grade">B Grade</option>
          <option value="C Grade">C Grade</option>
          <option value="Brown Rough">Brown Rough</option>
          <option value="Register">Register</option>
          <option value="Graph">Graph</option>
          <option value="other">Other (Manual Entry)</option>
        </select>
        <input type="text" id="manualPaperGrade" class="manual-input" placeholder="Enter Grade">
      </div>
      
      <div class="form-group">
        <label>Weight (Tonnes)</label>
        <input type="number" id="paperWeight" step="0.01">
      </div>
      <div class="form-group">
        <label>Number of Bundles/Reels</label>
        <input type="number" id="paperbundles" step="0.01">
      </div>
      <div class="form-group">
        <label>Price (â‚¹)</label>
        <input type="number" id="paperPrice" step="0.01">
      </div>
    </div>
  </div>

  <!-- Title Section -->
  <div class="section">
    <div class="section-title">TITLE</div>
    <div class="material-row">
      <div class="form-group">
        <label>Vendor</label>
        <select id="titleVendor" onchange="toggleManualInput('titleVendor')">
          <option value="">Select Vendor</option>
          <option value="Vani Paper">Vani Paper</option>
          <option value="Sai Baba">Sai Baba</option>
          <option value="Deevya Shakti">Deevya Shakti</option>
          <option value="other">Other (Manual Entry)</option>
        </select>
        <input type="text" id="manualTitleVendor" class="manual-input" placeholder="Enter Vendor Name">
      </div>
      
      <div class="form-group">
        <label>Company</label>
        <input type="text" id="titleCompany" placeholder="Enter Company">
      </div>
      
      <div class="form-group">
        <label>Type</label>
        <select id="titleType">
          <option value="">Select Type</option>
          <option value="Printed">Printed</option>
          <option value="Non Printed">Non Printed</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Size</label>
        <input type="text" id="titleSize" placeholder="Enter Size">
      </div>
      
      <div class="form-group">
        <label>GSM</label>
        <input type="number" id="titleGsm" placeholder="Enter GSM">
      </div>
      
      <div class="form-group">
        <label>Grade</label>
        <select id="titleGrade" onchange="toggleManualInput('titleGrade')">
          <option value="">Select Grade</option>
          <option value="A Grade">A Grade</option>
          <option value="B Grade">B Grade</option>
          <option value="C Grade">C Grade</option>
          <option value="Brown Rough">Brown Rough</option>
          <option value="Register">Register</option>
          <option value="Graph">Graph</option>
          <option value="other">Other (Manual Entry)</option>
        </select>
        <input type="text" id="manualTitleGrade" class="manual-input" placeholder="Enter Grade">
      </div>
      
      <div class="form-group">
        <label>Weight</label>
        <input type="number" id="titleWeight" step="0.01">
      </div>
      
      <div class="form-group">
        <label>No. of Sheets</label>
        <input type="number" id="titleSheets">
      </div>
      
      <div class="form-group">
        <label>Price (â‚¹)</label>
        <input type="number" id="titlePrice" step="0.01">
      </div>
    </div>
  </div>

  <!-- Pin Wire Section -->
  <div class="section">
    <div class="section-title">PIN WIRE</div>
    <div class="material-row">
      <div class="form-group">
        <label>Type</label>
        <select id="pinWireType" onchange="toggleManualInput('pinWireType')">
          <option value="">Select Type</option>
          <option value="Manual">Manual</option>
          <option value="Joy">Joy</option>
          <option value="Linomatic">Linomatic</option>
          <option value="other">Other (Manual Entry)</option>
        </select>
        <input type="text" id="manualPinWireType" class="manual-input" placeholder="Enter Type">
      </div>
      
      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="pinWireQuantity">
      </div>
      
      <div class="form-group">
        <label>Price (â‚¹)</label>
        <input type="number" id="pinWirePrice" step="0.01">
      </div>
    </div>
  </div>

  <!-- Shrink Film Section -->
  <div class="section">
    <div class="section-title">SHRINK FILM</div>
    <div class="material-row">
      <div class="form-group">
        <label>Size</label>
        <select id="shrinkFilmSize" onchange="toggleManualInput('shrinkFilmSize')">
          <option value="">Select Size</option>
          <option value="9">9</option>
          <option value="10">10</option>
          <option value="11">11</option>
          <option value="12">12</option>
          <option value="13">13</option>
          <option value="14">14</option>
          <option value="15">15</option>
          <option value="other">Other (Manual Entry)</option>
        </select>
        <input type="text" id="manualShrinkFilmSize" class="manual-input" placeholder="Enter Size">
      </div>
      
      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="shrinkFilmQuantity">
      </div>
      
      <div class="form-group">
        <label>Price (â‚¹)</label>
        <input type="number" id="shrinkFilmPrice" step="0.01">
      </div>
    </div>
  </div>

  <!-- Packing Patti Section -->
  <div class="section">
    <div class="section-title">PACKING PATTI</div>
    <div class="material-row">
      <div class="form-group">
        <label>Type</label>
        <select id="packingPattiType">
          <option value="">Select Type</option>
          <option value="Printed">Printed</option>
          <option value="Non Printed">Non Printed</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="packingPattiQuantity">
      </div>
      
      <div class="form-group">
        <label>Price (â‚¹)</label>
        <input type="number" id="packingPattiPrice" step="0.01">
      </div>
    </div>
  </div>

  <!-- Ink Section -->
  <div class="section">
    <div class="section-title">INK</div>
    <div class="material-row">
      <div class="form-group">
        <label>Colors</label>
        <input type="text" id="inkColors" placeholder="Enter Colors">
      </div>
      
      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="inkQuantity">
      </div>
      
      <div class="form-group">
        <label>Price (â‚¹)</label>
        <input type="number" id="inkPrice" step="0.01">
      </div>
    </div>
  </div>

  <!-- Flexo Section -->
  <div class="section">
    <div class="section-title">FLEXO</div>
    <div class="material-row">
      <div class="form-group">
        <label>Rules</label>
        <input type="text" id="flexoRules" placeholder="Enter Rules">
      </div>
      
      <div class="form-group">
        <label>Quantity</label>
        <input type="number" id="flexoQuantity">
      </div>
      
      <div class="form-group">
        <label>Price (â‚¹)</label>
        <input type="number" id="flexoPrice" step="0.01">
      </div>
    </div>
  </div>
</div>

<div style="text-align: center; margin-top: 30px;">
  <button id="submitBtn" onclick="submitData()">Submit Data</button>
  <div id="afterSubmitButtons" style="display: none;">
    <button onclick="window.print()">Print</button>
    <button onclick="enableEditing()">Back to Edit</button>
    <button onclick="saveData()">Save Data</button>
    <button onclick="newEntry()">New Entry</button>
  </div>
</div>

<script>
  // Web App URL for saving data
  const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-7vJlrqrmjxRlvO1YJaUgsXSCt271GVu-bULrPNW0cCGhstNtzZaeMKbwZt8qrUTO/exec';
  
  // Web App URL for getting invoice number
  const INVOICE_URL = 'https://script.google.com/macros/s/AKfycby-7vJlrqrmjxRlvO1YJaUgsXSCt271GVu-bULrPNW0cCGhstNtzZaeMKbwZt8qrUTO/exec';

  let currentInvoiceNumber = 0;

  // Toggle manual input fields
  function toggleManualInput(fieldName) {
    const selectElement = document.getElementById(fieldName);
    const manualInput = document.getElementById('manual' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1));
    
    if (selectElement.value === 'other') {
      manualInput.style.display = 'block';
    } else {
      manualInput.style.display = 'none';
      manualInput.value = '';
    }
  }

  // Get field value (either from dropdown or manual input)
  function getFieldValue(fieldName) {
    const selectElement = document.getElementById(fieldName);
    const manualInput = document.getElementById('manual' + fieldName.charAt(0).toUpperCase() + fieldName.slice(1));
    
    if (selectElement.value === 'other' && manualInput.value) {
      return manualInput.value;
    }
    return selectElement.value || '';
  }

  async function initializeInvoice() {
    const dateStr = new Date().toLocaleDateString('en-GB');
    document.getElementById("invoiceDate").innerText = dateStr;
    
    try {
      // Get the latest invoice number from Google Sheets
      const response = await fetch(INVOICE_URL + '?action=getInvoiceNumber');
      const data = await response.json();
      
      if (data.status === "success") {
        const lastInvoice = data.lastInvoiceNumber;
        if (lastInvoice && lastInvoice.startsWith('RM')) {
          currentInvoiceNumber = parseInt(lastInvoice.replace('RM', '')) || 0;
        } else {
          currentInvoiceNumber = 0;
        }
      } else {
        // Fallback to localStorage if API fails
        currentInvoiceNumber = parseInt(localStorage.getItem('lastRawMaterialInvoiceNumber') || "0");
      }
    } catch (error) {
      console.log('Using localStorage for invoice number:', error);
      // Fallback to localStorage if fetch fails
      currentInvoiceNumber = parseInt(localStorage.getItem('lastRawMaterialInvoiceNumber') || "0");
    }
    
    const nextInvoiceNumber = 'RM' + (currentInvoiceNumber + 1).toString().padStart(5, '0');
    document.getElementById("invoiceNo").innerText = nextInvoiceNumber;
  }

  function submitData() {
    // No validation - all fields are optional
    document.getElementById("submitBtn").style.display = "none";
    document.getElementById("afterSubmitButtons").style.display = "block";

    // Make fields read-only
    document.querySelectorAll("input, select").forEach(input => {
      input.setAttribute("readonly", true);
      input.style.backgroundColor = '#f5f5f5';
    });
  }

  function enableEditing() {
    document.getElementById("submitBtn").style.display = "inline-block";
    document.getElementById("afterSubmitButtons").style.display = "none";

    document.querySelectorAll("input, select").forEach(input => {
      input.removeAttribute("readonly");
      input.style.backgroundColor = '';
    });
  }

  function newEntry() {
    location.reload();
  }

  async function saveData() {
    const loadingIndicator = createLoadingIndicator('Saving data, please wait...');
    
    try {
      // Collect form data using getFieldValue function
      const formData = {
        invoiceNo: document.getElementById("invoiceNo").innerText,
        timeStamp: new Date().toLocaleString('en-IN'),
        // Paper data
        paperVendor: getFieldValue('paperVendor'),
        paperCompany: getFieldValue('paperCompany'),
        paperType: document.getElementById("paperType").value || '',
        paperSize: document.getElementById("paperSize").value || '',
        paperGsm: getFieldValue('paperGsm'),
        paperGrade: getFieldValue('paperGrade'),
        paperWeight: document.getElementById("paperWeight").value || '',
        paperbundles: document.getElementById("paperbundles").value || '',
        paperPrice: document.getElementById("paperPrice").value || '',
        // Title data
        titleVendor: getFieldValue('titleVendor'),
        titleCompany: document.getElementById("titleCompany").value || '',
        titleType: document.getElementById("titleType").value || '',
        titleSize: document.getElementById("titleSize").value || '',
        titleGsm: document.getElementById("titleGsm").value || '',
        titleGrade: getFieldValue('titleGrade'),
        titleWeight: document.getElementById("titleWeight").value || '',
        titleSheets: document.getElementById("titleSheets").value || '',
        titlePrice: document.getElementById("titlePrice").value || '',
        // Pin Wire data
        pinWireType: getFieldValue('pinWireType'),
        pinWireQuantity: document.getElementById("pinWireQuantity").value || '',
        pinWirePrice: document.getElementById("pinWirePrice").value || '',
        // Shrink Film data
        shrinkFilmSize: getFieldValue('shrinkFilmSize'),
        shrinkFilmQuantity: document.getElementById("shrinkFilmQuantity").value || '',
        shrinkFilmPrice: document.getElementById("shrinkFilmPrice").value || '',
        // Packing Patti data
        packingPattiType: document.getElementById("packingPattiType").value || '',
        packingPattiQuantity: document.getElementById("packingPattiQuantity").value || '',
        packingPattiPrice: document.getElementById("packingPattiPrice").value || '',
        // Ink data
        inkColors: document.getElementById("inkColors").value || '',
        inkQuantity: document.getElementById("inkQuantity").value || '',
        inkPrice: document.getElementById("inkPrice").value || '',
        // Flexo data
        flexoRules: document.getElementById("flexoRules").value || '',
        flexoQuantity: document.getElementById("flexoQuantity").value || '',
        flexoPrice: document.getElementById("flexoPrice").value || ''
      };

      console.log('Submitting data:', formData);

      // Save to Google Sheets with proper error handling
      const response = await fetch('https://script.google.com/macros/s/AKfycby-7vJlrqrmjxRlvO1YJaUgsXSCt271GVu-bULrPNW0cCGhstNtzZaeMKbwZt8qrUTO/exec', {
        method: 'POST',
	mode:'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
      });

      // Try to read the response if possible
      let result;
      try {
        result = await response.text();
        result = JSON.parse(result);
      } catch (e) {
        result = { status: 'success', message: 'Data submitted (CORS limitation)' };
      }

      // Update invoice number in localStorage
      localStorage.setItem('lastRawMaterialInvoiceNumber', currentInvoiceNumber + 1);
      
      loadingIndicator.innerHTML = `
        <div style="background:white; padding:20px; border-radius:5px; text-align:center;">
          <div style="color:green; margin-bottom:10px;">âœ… Data saved successfully!</div>
          <div style="font-size:12px; margin-bottom:15px;">Invoice: ${formData.invoiceNo}</div>
          <div style="font-size:10px; color:#666; margin-bottom:15px;">Data has been saved to respective sheets</div>
          <button onclick="closeLoading('${loadingIndicator.id}')" 
                  style="padding:8px 16px; background:#003366; color:white; border:none; cursor:pointer; margin:5px;">
            Close
          </button>
          <button onclick="location.reload()" 
                  style="padding:8px 16px; background:#28a745; color:white; border:none; cursor:pointer; margin:5px;">
            New Entry
          </button>
        </div>
      `;

    } catch (err) {
      console.error("Error saving data:", err);
      loadingIndicator.innerHTML = `
        <div style="background:white; padding:20px; border-radius:5px; text-align:center;">
          <div style="color:red; margin-bottom:10px;">Error saving data</div>
          <div style="font-size:10px; color:#666; margin-bottom:15px;">${err.toString()}</div>
          <button onclick="closeLoading('${loadingIndicator.id}')" 
                  style="padding:8px 16px; background:#003366; color:white; border:none; cursor:pointer;">
            Close
          </button>
        </div>
      `;
    }
  }

  function createLoadingIndicator(message) {
    const loadingIndicator = document.createElement('div');
    loadingIndicator.style.position = 'fixed';
    loadingIndicator.style.top = '0';
    loadingIndicator.style.left = '0';
    loadingIndicator.style.width = '100%';
    loadingIndicator.style.height = '100%';
    loadingIndicator.style.backgroundColor = 'rgba(0,0,0,0.5)';
    loadingIndicator.style.display = 'flex';
    loadingIndicator.style.justifyContent = 'center';
    loadingIndicator.style.alignItems = 'center';
    loadingIndicator.style.zIndex = '9999';
    
    const loadingId = 'loading-' + Date.now();
    loadingIndicator.id = loadingId;
    
    loadingIndicator.innerHTML = `
      <div style="background:white; padding:20px; border-radius:5px; text-align:center;">
        <div style="margin-bottom:10px;">${message}</div>
        <div class="spinner"></div>
      </div>
    `;
    document.body.appendChild(loadingIndicator);
    
    return loadingIndicator;
  }

  function closeLoading(id) {
    const loadingDiv = document.getElementById(id);
    if (loadingDiv) {
      loadingDiv.remove();
    }
  }
</script>
</body>
</html>